<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¡œì»¬ ë°ì´í„° ë³µì›</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #2196F3;
    }
    .warning {
      background: #fff3cd;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #ffc107;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .danger {
      background: #f44336;
    }
    .danger:hover {
      background: #da190b;
    }
    .log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      margin-bottom: 5px;
    }
    .log-success {
      color: #4CAF50;
    }
    .log-error {
      color: #f44336;
    }
    .log-info {
      color: #2196F3;
    }
    input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¦ ë¡œì»¬ ë°ì´í„° MongoDB ë³µì›</h1>
    
    <div class="info">
      <strong>â„¹ï¸ ì‚¬ìš© ë°©ë²•:</strong>
      <ol>
        <li>ë¨¼ì € ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬ JWT í† í°ì„ ë°›ìœ¼ì„¸ìš”</li>
        <li>ì•„ë˜ì— í† í°ì„ ì…ë ¥í•˜ì„¸ìš”</li>
        <li>"ë¡œì»¬ ë°ì´í„° ë³µì›" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ localStorageì˜ ê²Œì‹œê¸€ë“¤ì´ MongoDBì— ì €ì¥ë©ë‹ˆë‹¤</li>
      </ol>
    </div>

    <div class="warning">
      <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong>
      <ul>
        <li>ì´ ì‘ì—…ì€ í•œ ë²ˆë§Œ ì‹¤í–‰í•˜ì„¸ìš”</li>
        <li>ë³µì›ëœ ê²Œì‹œê¸€ì˜ ì‘ì„±ìëŠ” í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë¡œ ì„¤ì •ë©ë‹ˆë‹¤</li>
        <li>ëŒ“ê¸€ê³¼ ì¢‹ì•„ìš” ì •ë³´ë„ í•¨ê»˜ ë³µì›ë©ë‹ˆë‹¤</li>
      </ul>
    </div>

    <div>
      <label for="token">JWT í† í°:</label>
      <input 
        type="text" 
        id="token" 
        placeholder="ë¡œê·¸ì¸ í›„ ë°›ì€ í† í°ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"
      />
    </div>

    <div style="margin-top: 20px;">
      <button onclick="restoreData()">ğŸ“¤ ë¡œì»¬ ë°ì´í„° ë³µì›</button>
      <button onclick="checkLocalData()">ğŸ” ë¡œì»¬ ë°ì´í„° í™•ì¸</button>
      <button class="danger" onclick="clearLogs()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <div id="log" class="log" style="display: none;"></div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000';
    const logContainer = document.getElementById('log');

    function log(message, type = 'info') {
      logContainer.style.display = 'block';
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function clearLogs() {
      logContainer.innerHTML = '';
      logContainer.style.display = 'none';
    }

    function checkLocalData() {
      clearLogs();
      
      const posts = JSON.parse(localStorage.getItem('allInitialPosts') || '[]');
      
      if (posts.length === 0) {
        log('ë¡œì»¬ì— ì €ì¥ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
      }

      log(`ì´ ${posts.length}ê°œì˜ ê²Œì‹œê¸€ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.`, 'success');
      
      posts.forEach((post, index) => {
        log(`${index + 1}. "${post.title}" - ì‘ì„±ì: ${post.author}, ëŒ“ê¸€: ${post.comments?.length || 0}ê°œ`, 'info');
      });
    }

    async function restoreData() {
      const token = document.getElementById('token').value.trim();
      
      if (!token) {
        alert('JWT í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      clearLogs();
      log('ë³µì› ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');

      const posts = JSON.parse(localStorage.getItem('allInitialPosts') || '[]');
      
      if (posts.length === 0) {
        log('ë¡œì»¬ì— ì €ì¥ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
        alert('ë³µì›í•  ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      log(`ì´ ${posts.length}ê°œì˜ ê²Œì‹œê¸€ì„ ë³µì›í•©ë‹ˆë‹¤.`, 'info');

      let successCount = 0;
      let failCount = 0;

      for (let i = 0; i < posts.length; i++) {
        const post = posts[i];
        
        try {
          log(`[${i + 1}/${posts.length}] "${post.title}" ë³µì› ì¤‘...`, 'info');

          const response = await fetch(`${API_URL}/api/posts`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              title: post.title,
              content: post.content,
              category: post.category || 'comic',
              media: post.media || []
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          
          // ëŒ“ê¸€ ë³µì›
          if (post.comments && post.comments.length > 0) {
            log(`  â†’ ${post.comments.length}ê°œì˜ ëŒ“ê¸€ ë³µì› ì¤‘...`, 'info');
            
            for (const comment of post.comments) {
              try {
                await fetch(`${API_URL}/api/comments`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify({
                    postUuid: data.post.uuid,
                    content: comment.content,
                    parentId: null
                  })
                });
              } catch (commentError) {
                log(`  âš ï¸ ëŒ“ê¸€ ë³µì› ì‹¤íŒ¨: ${commentError.message}`, 'error');
              }
            }
          }

          successCount++;
          log(`âœ“ "${post.title}" ë³µì› ì™„ë£Œ`, 'success');

          // API ê³¼ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•œ ë”œë ˆì´
          await new Promise(resolve => setTimeout(resolve, 100));

        } catch (error) {
          failCount++;
          log(`âœ— "${post.title}" ë³µì› ì‹¤íŒ¨: ${error.message}`, 'error');
        }
      }

      log('', 'info');
      log('='.repeat(50), 'info');
      log(`ë³µì› ì™„ë£Œ! ì„±ê³µ: ${successCount}ê°œ, ì‹¤íŒ¨: ${failCount}ê°œ`, successCount > 0 ? 'success' : 'error');
      
      if (successCount > 0) {
        log('', 'info');
        log('ğŸ’¡ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ë³µì›ëœ ê²Œì‹œê¸€ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
        
        if (confirm('ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          window.location.href = '/';
        }
      }
    }
  </script>
</body>
</html>
